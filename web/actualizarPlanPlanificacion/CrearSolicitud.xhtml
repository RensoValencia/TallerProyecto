<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">
    <h:head>
        <title>Crear una solicitud de capacitacion</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <h:outputStylesheet library="css" name="planCapacitacion.css"/>
        <h:outputScript library="js" name="planCapacitacion.js"/>
        <f:event type="preRenderView" listener="#{plantillaBean.verificarSesion()}" />
    </h:head>
    <h:body>
        <ui:composition template="../templateIndra.xhtml">

            <ui:define name="top">
                <div style="text-align: left;color: white;font-size: 26px; display: inline">
                <img src="../img/indra.png" width="150px"  alt=""/>
            </div>
            <div style="display: inline; float: right;">
                <h:form>
                    <b>Bienvenido(a) <span style="color: palegreen">#{plantillaBean.usuario.nombres} #{plantillaBean.usuario.apellidos}</span>
                    - Ud. es del área <span style="color: palegreen">#{plantillaBean.usuario.idArea.nombre}</span> - Ud. tiene el puesto - 
                    <span style="color: palegreen">#{plantillaBean.usuario.idPerfil.nombre}</span></b> - 
                    <p:commandLink action="/usuario/Login.xhtml"
                                     actionListener="#{loginBean.cerrarSesion()}">
                        <h:outputText value="Cerrar sesión" />
                    </p:commandLink>
                </h:form>
            </div>
            </ui:define>
            <ui:define name="content">
                <h:form id="frmCrearSolicitud">

                    <p:blockUI id="block" block="frmCrearSolicitud" widgetVar="wgvFrmCrearSolicitud">
                        <p:graphicImage url="../img/load.gif" />
                    </p:blockUI>

                    <p:fieldset legend="Nueva Solicitud de Capacitación">
                        <p:panelGrid columns="8" layout="grid">
                            <p:column>
                                <h:outputLabel styleClass="anchoLabel" value="Tipo de plan:" style="font-weight: bold;" />
                            </p:column>
                            <p:column>
                                <p:selectOneRadio id="sorTipoPlan" value="#{crearSolicitudBean.tipoCapacitacionSeleccionada}">
                                    <f:selectItems value="#{crearSolicitudBean.listTipoCapacitacion}" var="tipoCapacitacion"
                                                   itemValue="#{tipoCapacitacion}" 
                                                   itemDisabled="#{tipoCapacitacion.flgEstado}"
                                                   itemLabel="#{tipoCapacitacion.descripcion}" />
                                </p:selectOneRadio>
                            </p:column>

                            <p:column>

                                <h:outputLabel styleClass="anchoLabel" value="Tipo de formación:"/>
                                <p:spacer width="10" />
                                <p:selectOneMenu id="somTipoFormacion"
                                                 value="#{crearSolicitudBean.tipoFormacionSeleccionada}">
                                    <f:selectItem itemLabel="[SELECCIONE]" itemValue="" />
                                    <f:selectItems value="#{crearSolicitudBean.listTipoFormacion}"
                                                   var="tipoFormacion" itemValue="#{tipoFormacion}" 
                                                   itemLabel="#{tipoFormacion.descripcion}" />
                                    <p:ajax update=":frmCrearSolicitud:somCurso" 
                                            process="@this :frmCrearSolicitud:sorTipoPlan: :frmCrearSolicitud:somTipoFormacion:"
                                            partialSubmit="true"
                                            onstart="PF('wgvFrmCrearSolicitud').show();"
                                            oncomplete="PF('wgvFrmCrearSolicitud').hide();"
                                            listener="#{crearSolicitudBean.buscarCurso()}" />
                                </p:selectOneMenu>
                            </p:column>

                            <p:column>
                                <h:outputLabel styleClass="anchoLabel" value="Cursos:"/>
                                <p:spacer width="10" />
                                <p:selectOneMenu id="somCurso" value="#{crearSolicitudBean.formacionSeleccionada}"
                                                 filter="true" filterMatchMode="contains">
                                    <f:selectItem itemLabel="[SELECCIONE]" itemValue="" noSelectionOption="true" />
                                    <f:selectItems value="#{crearSolicitudBean.listFormacion}"
                                                   var="curso" itemValue="#{curso}" itemLabel="#{curso.nombre}" />
                                </p:selectOneMenu>
                            </p:column>

                            <p:commandButton id="btnAgregar" action="#{crearSolicitudBean.agregarCurso}"
                                             value="Agregar"
                                             icon="ui-icon-circle-plus"
                                             onstart="PF('wgvFrmCrearSolicitud').show();"
                                             oncomplete="PF('wgvFrmCrearSolicitud').hide();"
                                             process="@this :frmCrearSolicitud:somCurso" partialSubmit="true" />

                            <h:panelGroup />
                        </p:panelGrid>
                    </p:fieldset>
                    <p:dataTable id="dtListDetalleSolicitud"
                                 reflow="true"
                                 var="detalleSolicitud"
                                 rowIndexVar="cantidad"
                                 emptyMessage="Listado de solicitudes de capacitación"
                                 value="#{crearSolicitudBean.listDetalleSolicitud}">
                        <p:column id="colNro" headerText="Nro">
                            <h:outputText value="#{cantidad + 1}" />
                        </p:column>
                        <p:column id="colTipoFormacion" headerText="Tipo formación">
                            <h:outputText value="#{detalleSolicitud.idFormacion.idTipoCapacitacion.descripcion}" />
                        </p:column>
                        <p:column id="colFormacion" headerText="Formación">
                            <h:outputText value="#{detalleSolicitud.idFormacion.nombre}" />
                        </p:column>
                        <p:column id="colMaxPar" headerText="Maximo participantes">
                            <h:outputText value="#{detalleSolicitud.idFormacion.maximoParticipantes}" />
                        </p:column>
                        <p:column id="colInscritos" headerText="Participantes inscritos">
                            <h:outputText value="#{detalleSolicitud.numeroParticipantes}" />
                        </p:column>
                        <p:column id="colAgregar" headerText="Agregar participante">
                            <p:commandButton icon="ui-icon-circle-plus"
                                             process="@this"
                                             partialSubmit="true"
                                             action="#{crearSolicitudBean.agregarListadoParticipantes(detalleSolicitud)}" />
                        </p:column>
                        <p:column id="colRemover" headerText="Remover">
                            <p:commandButton id="btnRemover"
                                             icon="ui-icon-circle-minus" 
                                             onstart="PF('wgvFrmCrearSolicitud').show();"
                                             oncomplete="PF('wgvFrmCrearSolicitud').hide();"
                                             process="@this :frmCrearSolicitud:dtListDetalleSolicitud"
                                             partialSubmit="true"
                                             action="#{crearSolicitudBean.eliminarCurso(detalleSolicitud)}">
                                <p:confirm header="Mensaje de validacion" 
                                           message="¿Estas seguro de eliminar el detalle de solicitud?" icon="ui-icon-alert" />
                            </p:commandButton>

                            <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
                                <p:commandButton value="SI" type="button" styleClass="ui-confirmdialog-yes" icon="ui-icon-check" />
                                <p:commandButton value="NO" type="button" styleClass="ui-confirmdialog-no" icon="ui-icon-close" />
                            </p:confirmDialog>
                        </p:column>
                    </p:dataTable>

                    <p:commandButton value="Grabar"
                                     icon="ui-icon-disk"
                                     onstart="PF('wgvFrmCrearSolicitud').show();"
                                     oncomplete="PF('wgvFrmCrearSolicitud').hide();"
                                     action="#{crearSolicitudBean.confirmarGrabacion}" />
                    
                    <p:commandButton value="Salir"
                                         icon="ui-icon-circle-close"
                                         onstart="PF('wgvFrmCrearSolicitud').show();"
                                         oncomplete="PF('wgvFrmCrearSolicitud').hide();"
                                         action="/solicitudCapacitacion/List.xhtml" />
                </h:form>


                <p:dialog id="dlgSeleccionarParticipantes" 
                          modal="true" 
                          header="Participantes asociados al detalle de capacitacion" 
                          widgetVar="wgvDlgSeleccionarParticipantes"
                          resizable="false" 
                          position="center"
                          closeOnEscape="true"
                          minimizable="false" 
                          width="70%" height="80%">
                    <h:form id="frmListadoParticipante">
                        <p:toolbar>
                            <f:facet name="left">
                                <p:commandButton id="btnAgregarPar" value="Agregar"
                                                 icon="ui-icon-circle-plus"
                                                 onstart="PF('wgvFrmCrearSolicitud').show();"
                                                 oncomplete="PF('wgvFrmCrearSolicitud').hide();"
                                                 process="@this :frmListadoParticipante"
                                                 partialSubmit="true"
                                                 action="#{crearSolicitudBean.agregarListadoParticipantes2}"
                                                 />
                                <p:commandButton id="btnSalirAgregar" value="Salir" 
                                                 icon="ui-icon-circle-close"
                                                 oncomplete="PF('wgvDlgSeleccionarParticipantes').hide()"  />

                            </f:facet>
                        </p:toolbar>
                        <p:dataTable id="dtListadoParticipante" 
                                     var="participante"
                                     reflow="true"
                                     rowIndexVar="cantidad"
                                     rowKey="#{participante.id}"
                                     value="#{crearSolicitudBean.listParticipante}">
                            <p:column id="colNro" headerText="Nro">
                                <h:outputText value="#{cantidad + 1}" />
                            </p:column>
                            <p:column id="colNombres" headerText="Nombres">
                                <h:outputText value="#{participante.idParticipante.idUsuario.nombres}" />
                            </p:column>
                            <p:column id="colApellidos" headerText="Apellidos">
                                <h:outputText value="#{participante.idParticipante.idUsuario.apellidos}" />
                            </p:column>
                            <p:column id="colUsuario" headerText="Usuario">
                                <h:outputText value="#{participante.idParticipante.idUsuario.usuario}" />
                            </p:column>
                            <p:column id="colPerfil" headerText="Perfil">
                                <h:outputText value="#{participante.idParticipante.idUsuario.idPerfil.nombre}" />
                            </p:column>
                            <p:column id="colRemover" headerText="Remover">
                                
                                <p:commandButton id="btnRemoverParticipante"
                                             icon="ui-icon-circle-minus" 
                                             onstart="PF('wgvFrmCrearSolicitud').show();"
                                             oncomplete="PF('wgvFrmCrearSolicitud').hide();"
                                             process="@this :frmListadoParticipante:dtListadoParticipante"
                                             partialSubmit="true"
                                             action="#{crearSolicitudBean.eliminarParticipante(participante)}">
                                    <p:confirm header="Mensaje de validacion" 
                                               message="¿Estas seguro de eliminar al participante?" icon="ui-icon-alert" />
                                </p:commandButton>

                                <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
                                    <p:commandButton value="SI" type="button" styleClass="ui-confirmdialog-yes" icon="ui-icon-check" />
                                    <p:commandButton value="NO" type="button" styleClass="ui-confirmdialog-no" icon="ui-icon-close" />
                                </p:confirmDialog>
                            </p:column>
                        </p:dataTable>
                    </h:form>
                </p:dialog>

                <p:dialog id="dlgSeleccionarParticipantesSeleccionar" 
                          modal="true" 
                          header="Seleccionar participantes para el detalle de capacitacion" 
                          widgetVar="wgvDlgSeleccionarParticipantesSeleccionar"
                          resizable="false" 
                          position="center"
                          closeOnEscape="true"
                          minimizable="false" 
                          width="70%" height="80%">
                    <h:form id="frmListadoParticipanteSeleccionar">
                        <p:dataTable id="dtListadoParticipanteSeleccionar" 
                                     var="participante"
                                     reflow="true"
                                     selection="#{crearSolicitudBean.listParticipanteTemp}"
                                     rowIndexVar="cantidad"
                                     rowKey="#{participante.id}"
                                     value="#{crearSolicitudBean.listParticipanteArea}">
                            <p:column id="colNro" headerText="Nro">
                                <h:outputText value="#{cantidad + 1}" />
                            </p:column>
                            <p:column id="colCheck" selectionMode="multiple" style="width:16px;text-align:center"/>
                            <p:column id="colTipoFormacion" headerText="Nombres">
                                <h:outputText value="#{participante.idUsuario.nombres}" />
                            </p:column>
                            <p:column id="colFormacion" headerText="Apellidos">
                                <h:outputText value="#{participante.idUsuario.apellidos}" />
                            </p:column>
                            <p:column id="colMaxPar" headerText="Usuario">
                                <h:outputText value="#{participante.idUsuario.usuario}" />
                            </p:column>
                            <p:column id="colPerfil" headerText="Perfil">
                                <h:outputText value="#{participante.idUsuario.idPerfil.nombre}" />
                            </p:column>
                        </p:dataTable>
                        <p:commandButton value="Guardar"
                                         icon="ui-icon-disk"
                                         onstart="PF('wgvFrmCrearSolicitud').show();"
                                         oncomplete="PF('wgvFrmCrearSolicitud').hide();"
                                         action="#{crearSolicitudBean.guardarParticipante}"
                                         >
                            <p:confirm header="Mensaje de validacion" 
                                       message="¿Estas seguro agregar solo a estos participante, por favor verifica?" icon="ui-icon-alert" />
                        </p:commandButton>

                        <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
                            <p:commandButton value="SI" type="button" styleClass="ui-confirmdialog-yes" icon="ui-icon-check" />
                            <p:commandButton value="NO" type="button" styleClass="ui-confirmdialog-no" icon="ui-icon-close" />
                        </p:confirmDialog>

                    </h:form>
                </p:dialog>
            </ui:define>
        </ui:composition>
    </h:body>
</html>